machine:
  php:
    version: 7.0.4

checkout:
  post:
    - git submodule sync
    - git submodule update --init
    - ln -s /home/ubuntu/vae_remote/tests/dependencies/vae_thrift /home/ubuntu/vae_thrift

dependencies:
  cache_directories:
    - thrift-0.9.2
    - libs3
    - /home/ubuntu/apt-cache
  pre:
    - sudo rm -rf /var/cache/apt/archives && mkdir -p /home/ubuntu/apt-cache/partial && sudo ln -s /home/ubuntu/apt-cache /var/cache/apt/archives
    - sudo add-apt-repository -y ppa:chris-lea/zeromq
    - sudo apt-get update; sudo apt-get install libantlr3c-dev libzmq3-dev libboost-filesystem-dev libboost-program-options-dev libboost-system-dev libboost-thread-dev libpcre3-dev libmemcached-dev libmysqlcppconn-dev
    - if [[ ! -e libs3/build/bin/s3 ]]; then git clone git@github.com:bji/libs3.git; fi && cd libs3 && sudo make install
    - if [[ ! -e thrift-0.9.2/lib/cpp/libthrift.la ]]; then wget https://archive.apache.org/dist/thrift/0.9.2/thrift-0.9.2.tar.gz && tar -zxvf thrift-0.9.2.tar.gz && cd thrift-0.9.2 && ./configure --disable-tests --without-tests --without-qt4 --without-java --without-nodejs --without-haskell --without-go --without-d --without-perl --without-lua --without-python --without-erlang --without-ruby && make; fi && sudo make install && sudo ldconfig
    - cd tests/dependencies/vaeql && make && make install
    - cd tests/dependencies/vae_thrift/cpp && ./configure && make
    - echo "extension=vaeql.so" > ~/.phpenv/versions/$(phpenv global)/etc/conf.d/vaeql.ini
  post:
    - cd /home/ubuntu/vae_thrift/rb && bundle && bundle exec ruby vaerubyd.rb:
        background: true
    - cd /home/ubuntu/vae_thrift/cpp && ./vaedb --test:
        background: true

test:
  override:
    - cd /home/ubuntu/vae_remote && php tests/_all.php
