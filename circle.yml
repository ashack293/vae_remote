machine:
  php:
    version: 7.0.4

checkout:
  post:
    - git submodule sync
    - git submodule update --init
    - ln -s /home/ubuntu/vae_remote/tests/dependencies/vae_thrift /home/ubuntu/vae_thrift

dependencies:
  pre:
    - sudo apt-get update; sudo apt-get install libantlr3c-dev libzmq-dev libpcre3-dev libmemcached-dev libmysqlcppconn-dev
    - git clone git@github.com:bji/libs3.git && cd libs3 && sudo make install
    - wget https://archive.apache.org/dist/thrift/0.9.2/thrift-0.9.2.tar.gz && tar -zxvf thrift-0.9.2.tar.gz && ./configure --disable-tests && make && sudo make install && ldconfig
    - cd tests/dependencies/vaeql && make && make install
    - cd tests/dependencies/vae_thrift/cpp && ./configure && make && make install
    - echo "extension=vaeql.so" > ~/.phpenv/versions/$(phpenv global)/etc/conf.d/vaeql.ini
  post:
    - cd /home/ubuntu/vae_thrift/rb && bundle exec ruby vaerubyd.rb:
        background: true
    - cd /home/ubuntu/vae_thrift/cpp && ./vaedb --test:
        background: true

test:
  override:
    - php tests/_all.php
